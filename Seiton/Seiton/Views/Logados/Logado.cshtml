@{
    ViewData["Title"] = "Logado";
}

@model ViewModel
<link rel="stylesheet" type="text/css" href="/css/Logado.css" media="screen" />

<div class="Container">
    
    <div class="side-bar-background">
        <div class="white-blue">
            <h1>Projetos</h1>
            <ul>
                @foreach (var projeto in Model.Nome_projeto.Zip(Model.ProjetoId, (nomeProjeto, ProjetoId) => new { NomeProjeto = nomeProjeto, ProjetoId = ProjetoId }))
                {
                    <li>
                        <a class="project-name" asp-area="" asp-route-id="@projeto.ProjetoId">@projeto.NomeProjeto</a>
                    </li>
                }
                
            </ul>
            <div class="adicionar">
                <span class="material-symbols-outlined">add</span>
                <button class="nav-link text-dark" asp-area="" onclick="ModalOpen(0, '/Projetos/Create/')">Novo</button>
            </div>
            <hr />
        </div>
    </div>

    <div class="Container_Body">
            @if (User.Identity.IsAuthenticated)
            {
                <h1 class="project-name-dropdown">@ViewData["userName"]</h1>

            <div class="dropdown" onclick="joaquim()">
                    <img class="dropdown-image" src="/img/man.png" alt="Imagem de Menu">
                    <div class="dropdown-content">
                    <button class="nav-link text-dark" asp-area="" onclick="ModalOpen(@ViewData["userId"], '/Usuarios/Edit/')"><img src="/img/edit.png" class="foto-button" />Editar</button>
                    <button class="nav-link text-dark" asp-area="" onclick="ModalOpen(@ViewData["userId"], '/Usuarios/Delete/')"><img src="/img/delete.png" class="foto-button" />Apagar</button>
                    <a class="nav-link text-dark" asp-area="" asp-controller="Usuarios" asp-action="Logout"><img src="/img/logout.png" class="foto-button" />Sair</a>
                    </div>
                </div>
            }

        <div class="info_container">
            <h1>Projeto:</h1>
            <h4>@ViewData["NomeProjeto"]</h4>
            @if (@ViewData["ProjetoId"] != null)
            {
                <details>
                    <summary></summary>
                    <button class="nav-link text-dark" asp-area="" onclick="ModalOpen(@ViewData["ProjetoId"], '/Projetos/Edit/' )"><img src="/img/edit.png" class="foto-button" />Editar</button>
                    <button class="nav-link text-dark" asp-area="" onclick="ModalOpen(@ViewData["ProjetoId"], '/Projetos/Delete/')"><img src="/img/delete.png" class="foto-button" />Apagar</button>
                    <button class="nav-link text-dark" asp-area="" onclick="ModalOpen(@ViewData["ProjetoId"], '/Logados/Report/')"><img src="/img/report.png" class="foto-button" />Relatório</button>
                </details>
            }

        </div>

        <div class="colum_container">
            
            @if (Model.NomeColuna != null)
            {
                var c = 0;
                var colunas = Model.NomeColuna.Zip(Model.IdColuna, (nomecoluna, idcoluna) => new { NomeColuna = nomecoluna, IdColuna = idcoluna })
                .Zip(Model.CorColuna, (coluna, cor) => new { NomeColuna = coluna.NomeColuna, IdColuna = coluna.IdColuna, CorColuna = cor });


                @foreach (var Coluna in colunas)
                {

                    var tarefasCombinadas = Model.IdTarefa

                    .Zip(Model.NomeTarefas.Zip(Model.descricao, (nomeTarefa, desc) => new { NomeTarefa = nomeTarefa, Descricao = desc }),
                    (idTarefa, tarefa) => new { IdTarefa = idTarefa, Tarefa = tarefa })
                    
                    .Zip(Model.Responsavel.Zip(Model.Prioridade, (resp, prioridade) => new { Responsavel = resp, Prioridade = prioridade }),
                    (tarefa, respPrioridade) => new
                    {
                        IdTarefa = tarefa.IdTarefa,
                        NomeTarefa = tarefa.Tarefa.NomeTarefa,
                        Descricao = tarefa.Tarefa.Descricao,
                        Responsavel = respPrioridade.Responsavel,
                        Prioridade = respPrioridade.Prioridade
                    })
                    .Where(tarefa => tarefa.IdTarefa == Coluna.IdColuna);

                    // Obtendo a quantidade de tarefas

                    var quant = Model.IdTarefa

                    .Zip(Model.IdTarefa.Zip(Model.IdColunaFK, (id, fkid) => new { IdTarefa = id, IdColunaFK = fkid }),
                    (idTarefa, fk) => new 
                    {
                        IdTarefa = idTarefa,
                        ColunasId = fk.IdColunaFK
                    }).Where(tarefa => tarefa.IdTarefa == Coluna.IdColuna);

                    int QuantTarefas = quant.Count(t => t.ColunasId == Coluna.IdColuna);
                    ViewData["QuantTarefas"] = QuantTarefas;

                    <div class="columContainerInt">
                    
                        <div class="coluna">
                            <div class="color_colum" style="background-color: @Coluna.CorColuna;"><div class="icolor_colum"></div></div>
                            <h3>@Coluna.NomeColuna</h3>
                            <button type="button" id="openModalBtn" onclick="ModalOpen(@Coluna.IdColuna, '/Colunas/Edit/')"><img src="/img/edit.png" /></button>
                        </div>
                        <h4 class="NTarefas">Nº de Tarefas:@ViewData["QuantTarefas"]</h4>
                        <hr />

                            @if (c == 0)
                            {
                                <div id="adicionarTarefa" >
                                    <span class="material-symbols-outlined">
                                        add
                                    </span>
                                <button class="nav-link text-dark" asp-area="" onclick="ModalOpen(@ViewData["IdProjetoAtual"], '/Tarefas/Create/')">Nova tarefa</button>
                                </div>
                            }

                        @foreach (var tarefa in tarefasCombinadas)
                        {
                            if (tarefa.Prioridade == 1)
                            {
                                <div class="tarefa prioridade-baixa" id="tarefaId">
                                    <h4>@tarefa.Responsavel</h4>
                                    <div class="paragrafo2">
                                        <h2>@tarefa.NomeTarefa</h2>
                                    </div>
                                    <hr>
                                    <div class="paragrafo"><p>@tarefa.Descricao</p></div>
                                </div>
                            }
                            else if (tarefa.Prioridade == 2)
                            {
                                <div class="tarefa prioridade-media" id="tarefaId">
                                    <h4>@tarefa.Responsavel</h4>
                                    <div class="paragrafo2">
                                        <h2>@tarefa.NomeTarefa</h2>
                                    </div>
                                    <hr>
                                    <div class="paragrafo"><p>@tarefa.Descricao</p></div>
                                </div>
                            }
                            else if (tarefa.Prioridade == 3)
                            {
                                <div class="tarefa prioridade-alta" id="tarefaId">
                                    <h4>@tarefa.Responsavel</h4>
                                    <div class="paragrafo2">
                                        <h2>@tarefa.NomeTarefa</h2>
                                    </div>
                                    <hr>
                                    <div class="paragrafo"><p>@tarefa.Descricao</p></div>
                                </div>
                            }
                            
                        }
                    </div>

                    c = 1;
                }
            }
        </div>
    </div>

    <!-- Modal -->
    <div id="myModalE" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModalBtn">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

</div>
